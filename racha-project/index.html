<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Racha Map - Final Master Stable</title>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css' type='text/css' />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />

    <style>
        @import url('https://fonts.cdnfonts.com/css/sf-pro-display');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@100..900&display=swap');

        :root {
            --glass: rgba(255, 255, 255, 0.03) !important;
            --glass-blur: blur(35px) saturate(180%) !important;
            --border: rgba(255, 255, 255, 0.12) !important;
            --custom-green: #7fb069 !important;
        }

        .light-mode-active { --glass: rgba(255, 255, 255, 0.35) !important; --border: rgba(0, 0, 0, 0.08) !important; }

        body { margin: 0; padding: 0; font-family: "SF Pro Display", "Noto Sans Georgian", sans-serif; background: #000; overflow: hidden; color: #fff; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        .mapboxgl-ctrl-bottom-left, .mapboxgl-ctrl-bottom-right { display: none !important; }

        /* --- ðŸ›‘ Main Bar Perfection --- */
        .main-bar { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); 
            z-index: 25; display: flex; align-items: center; 
            background: var(--glass); backdrop-filter: var(--glass-blur); 
            padding: 0 30px; border-radius: 100px; border: 0.5px solid var(--border); 
            width: 95%; max-width: 1000px; height: 42px; justify-content: space-between;
            box-shadow: 0 8px 32px 0 rgba(0,0,0,0.5);
        }

        /* --- Search Center Fix --- */
        .mapboxgl-ctrl-geocoder { 
            background: rgba(255,255,255,0.08) !important; border-radius: 100px !important; 
            width: 250px !important; height: 28px !important; display: flex !important; 
            align-items: center !important; justify-content: center !important; 
            box-shadow: none !important; border: 0.5px solid var(--border) !important;
        }
        .mapboxgl-ctrl-geocoder--input { color: #fff !important; padding: 0 35px !important; font-size: 11px !important; background: none !important; border: none !important; height: 100% !important; }
        .mapboxgl-ctrl-geocoder--icon-search { left: 12px !important; top: 50% !important; transform: translateY(-50%) !important; fill: #fff !important; width: 14px !important; }
        .mapboxgl-ctrl-geocoder--button { background: none !important; top: 50% !important; transform: translateY(-50%) !important; }
        .suggestions { background: rgba(10, 10, 10, 0.85) !important; backdrop-filter: blur(40px) !important; border-radius: 20px !important; border: 0.5px solid var(--border) !important; }

        /* --- Controls --- */
        .side-controls, .right-controls { position: absolute; top: 20px; z-index: 20; display: flex; flex-direction: column; gap: 10px; transition: top 0.3s; }
        .side-controls { left: 15px; } .right-controls { right: 15px; }

        @media (max-width: 900px) { .side-controls, .right-controls { top: 80px; } .nav-links { display: none; } .main-bar { width: 85%; } }

        .btn-circle { width: 38px; height: 38px; border-radius: 50%; background: var(--glass); backdrop-filter: var(--glass-blur); border: 0.5px solid var(--border); color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .btn-circle.active { background: var(--custom-green) !important; border-color: var(--custom-green) !important; }
        .btn-circle:hover { background: rgba(255,255,255,0.1); }

        /* --- Widgets --- */
        .weather-widget { position: absolute; left: 45px; top: 0; width: 130px; background: var(--glass); backdrop-filter: var(--glass-blur); border-radius: 20px; padding: 15px; border: 0.5px solid var(--border); color: #fff; opacity: 0; visibility: hidden; transition: 0.4s; z-index: 100; }
        .weather-container:hover .weather-widget { opacity: 1; visibility: visible; }
        .sub-layers { position: absolute; left: 45px; display: flex; gap: 8px; opacity: 0; visibility: hidden; transition: 0.4s; }
        .layer-group:hover .sub-layers { opacity: 1; visibility: visible; }

        /* --- Auth Modal --- */
        #authModal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; z-index: 100; display: none; flex-direction: column; gap: 18px; }
        .modal-input, .modal-btn { background: var(--glass) !important; backdrop-filter: var(--glass-blur); border: 0.5px solid var(--border) !important; border-radius: 100px; padding: 14px 25px; color: #fff !important; outline: none; font-size: 13px; }
        .modal-btn { cursor: pointer; transition: 0.3s; font-weight: 700; }
        .modal-btn:hover { background: var(--custom-green) !important; }

        .nav-links { display: flex; gap: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; align-items: center; }
        .nav-links span { cursor: pointer; opacity: 0.5; transition: 0.3s; }
        .nav-links span.active { opacity: 1; color: #fff; }
        .material-symbols-outlined { font-variation-settings: 'wght' 200; font-size: 18px; color: #fff !important; }
    </style>
</head>
<body id="bdy">

    <div id="map"></div>

    <div class="side-controls">
        <button class="btn-circle" onclick="window.toggleTheme()"><span class="material-symbols-outlined" id="thIcon">light_mode</span></button>
        
        <div class="weather-container" style="position:relative;">
            <button class="btn-circle"><span id="btnTemp" style="font-size: 11px; font-weight: 700;">--Â°</span></button>
            <div class="weather-widget">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span id="widgetTemp" style="font-size: 14px; font-weight: 600;">--Â°C</span>
                    <span class="material-symbols-outlined" style="color:#ffcc00 !important; font-size: 18px;">wb_sunny</span>
                </div>
                <div style="font-size: 9px; opacity: 0.8; margin-top: 8px;">Humidity: <b id="hum">--%</b></div>
            </div>
        </div>

        <div class="layer-group" style="position:relative;">
            <button class="btn-circle" id="mastLyr" onclick="window.toggleAllLayers(this)"><span class="material-symbols-outlined">layers</span></button>
            <div id="subLyrs" class="sub-layers">
                <button class="btn-circle" id="btn-admin" onclick="window.toggleSingleLayer('admin', this)"><span class="material-symbols-outlined">map</span></button>
                <button class="btn-circle" id="btn-roads" onclick="window.toggleSingleLayer('roads', this)"><span class="material-symbols-outlined">directions_car</span></button>
                <button class="btn-circle active" id="btn-place" onclick="window.toggleSingleLayer('place', this)"><span class="material-symbols-outlined">home</span></button>
                <button class="btn-circle" id="btn-3d" onclick="window.toggleSingleLayer('3d', this)"><span class="material-symbols-outlined">apartment</span></button>
            </div>
        </div>

        <button class="btn-circle" onclick="window.zoomIn()"><span class="material-symbols-outlined">add</span></button>
        <button class="btn-circle" onclick="window.zoomOut()"><span class="material-symbols-outlined">remove</span></button>
    </div>

    <div class="main-bar">
        <div style="display:flex; align-items:center; gap:10px; font-size:11px; font-weight: 700;">
            Location <label style="position:relative; display:inline-block; width:34px; height:18px;">
                <input type="checkbox" onchange="window.getUserLoc(this)" style="opacity:0; width:0; height:0;">
                <span style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.15); border-radius:34px; transition:.4s;"></span>
                <span id="slider-dot" style="position:absolute; height:12px; width:12px; left:3px; bottom:3px; background:white; border-radius:50%; transition:.4s;"></span>
            </label>
        </div>

        <div id="geocoder-box"></div>

        <div class="nav-links">
            <span class="active" id="txt-all">ALL</span>
            <span id="txt-land">LANDMARKS</span>
            <span id="txt-rest">RESTAURANTS</span>
            <span id="txt-hot">HOTELS</span>
            <span id="txt-tours">TOURS</span>
        </div>

        <div class="btn-circle" style="width:28px; height:28px; border:none; background:rgba(255,255,255,0.1);"><span class="material-symbols-outlined" style="font-size:16px;">tune</span></div>
    </div>

    <div class="right-controls">
        <button class="btn-circle" onclick="window.toggleAuth()"><span class="material-symbols-outlined">person</span></button>
        <button class="btn-circle" id="lBtn" onclick="window.toggleLang()" style="font-size: 11px; font-weight: 700;">GE</button>
    </div>

    <div id="authModal">
        <div style="position:absolute; top:-45px; left:50%; transform:translateX(-50%); cursor:pointer;" onclick="window.toggleAuth()"><span class="material-symbols-outlined" style="font-size: 26px;">close</span></div>
        <input type="email" id="email" class="modal-input" placeholder="áƒ”áƒš-áƒ¤áƒáƒ¡áƒ¢áƒ" autocomplete="off">
        <input type="password" id="pass" class="modal-input" placeholder="áƒžáƒáƒ áƒáƒšáƒ˜" autocomplete="off">
        <button class="modal-btn" onclick="window.handleAuth()">LOGIN</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        const firebaseConfig = { apiKey: "AIzaSyAJbHfM7kT614kX9DBegyMQn1zALl6m23c", authDomain: "racha-map.firebaseapp.com", projectId: "racha-map", storageBucket: "racha-map.firebasestorage.app", messagingSenderId: "240476452622", appId: "1:240476452622:web:c63b9a525740e235b3095f" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // ðŸ›‘ Window Functions (Unbreakable)
        window.toggleTheme = () => { document.body.classList.toggle('light-mode-active'); const i = document.getElementById('thIcon'); i.innerText = i.innerText === 'light_mode' ? 'dark_mode' : 'light_mode'; };
        window.toggleAuth = () => { const m = document.getElementById('authModal'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; };
        window.zoomIn = () => map.zoomIn(); window.zoomOut = () => map.zoomOut();
        window.handleAuth = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value); alert("Success!"); window.toggleAuth(); } catch (e) { alert("Error!"); } };

        let curL = 'ka';
        window.toggleLang = () => {
            curL = curL === 'ka' ? 'en' : 'ka';
            document.getElementById('lBtn').innerText = curL === 'ka' ? 'GE' : 'EN';
            document.getElementById('txt-all').innerText = curL === 'ka' ? 'áƒ§áƒ•áƒ”áƒšáƒ' : 'ALL';
            document.getElementById('txt-land').innerText = curL === 'ka' ? 'áƒ¦áƒ˜áƒ áƒ¡áƒ¨áƒ”áƒ¡áƒáƒœáƒ˜áƒ¨áƒœáƒáƒáƒ‘áƒ”áƒ‘áƒ˜' : 'LANDMARKS';
            document.getElementById('txt-rest').innerText = curL === 'ka' ? 'áƒ áƒ”áƒ¡áƒ¢áƒáƒ áƒœáƒ”áƒ‘áƒ˜' : 'RESTAURANTS';
            document.getElementById('txt-hot').innerText = curL === 'ka' ? 'áƒ¡áƒáƒ¡áƒ¢áƒ£áƒ›áƒ áƒáƒ”áƒ‘áƒ˜' : 'HOTELS';
            document.getElementById('txt-tours').innerText = curL === 'ka' ? 'áƒ¢áƒ£áƒ áƒ”áƒ‘áƒ˜' : 'TOURS';
            map.getStyle().layers.forEach(l => { if (l.layout && l.layout['text-field']) map.setLayoutProperty(l.id, 'text-field', ['coalesce', ['get', 'name_' + curL], ['get', 'name_en'], ['get', 'name']]); });
        };

        // Map Setup
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2FidWthNjI5IiwiYSI6ImNtbHBza2JqcDFjZ2EzZ3F4YjVuN3EwMmoifQ.V6q1KO4tol7QefPr8PQFxQ';
        const map = new mapboxgl.Map({ container: 'map', style: 'mapbox://styles/mapbox/satellite-streets-v12', center: [43.1481, 42.5176], zoom: 11, pitch: 60 });

        map.on('style.load', () => {
            map.getStyle().layers.forEach(l => { if (l.type === 'symbol' && (l.id.includes('poi') || l.id.includes('shield'))) map.setLayoutProperty(l.id, 'visibility', 'none'); });
            if (!map.getSource('mapbox-dem')) { map.addSource('mapbox-dem', { 'type': 'raster-dem', 'url': 'mapbox://mapbox.mapbox-terrain-dem-v1', 'tileSize': 512 }); map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.6 }); }
            if (!map.getLayer('3d-buildings')) {
                map.addLayer({ 'id': '3d-buildings', 'source': 'composite', 'source-layer': 'building', 'type': 'fill-extrusion', 'minzoom': 14, 'paint': { 'fill-extrusion-color': '#aaa', 'fill-extrusion-height': ['get', 'height'], 'fill-extrusion-opacity': 0.6 } });
                map.setLayoutProperty('3d-buildings', 'visibility', 'none');
            }
        });

        const geocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl: mapboxgl, placeholder: 'Search...', marker: false });
        document.getElementById('geocoder-box').appendChild(geocoder.onAdd(map));

        window.toggleAllLayers = (btn) => {
            const act = btn.classList.toggle('active');
            ['admin', 'roads', 'place', '3d'].forEach(t => {
                const s = document.getElementById('btn-' + t);
                if (s) act ? s.classList.add('active') : s.classList.remove('active');
                map.getStyle().layers.forEach(l => {
                    if ((t==='admin' && l.id.includes('admin')) || (t==='roads' && l.id.includes('road')) || (t==='place' && l.id.includes('settlement')) || (t==='3d' && l.id==='3d-buildings')) map.setLayoutProperty(l.id, 'visibility', act?'visible':'none');
                });
            });
        };

        window.toggleSingleLayer = (t, b) => {
            const v = b.classList.toggle('active') ? 'visible' : 'none';
            map.getStyle().layers.forEach(l => {
                if ((t==='admin' && l.id.includes('admin')) || (t==='roads' && l.id.includes('road')) || (t==='place' && l.id.includes('settlement')) || (t==='3d' && l.id==='3d-buildings')) map.setLayoutProperty(l.id, 'visibility', v);
            });
        };

        async function fetchW() { try { const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=42.5176&longitude=43.1481&current_weather=true&hourly=relativehumidity_2m`); const d = await r.json(); document.getElementById('btnTemp').innerText = Math.round(d.current_weather.temperature) + 'Â°'; document.getElementById('widgetTemp').innerText = Math.round(d.current_weather.temperature) + 'Â°C'; document.getElementById('hum').innerText = d.hourly.relativehumidity_2m[0] + '%'; } catch(e){} }
        fetchW();
        window.getUserLoc = (el) => { if (el.checked) { navigator.geolocation.getCurrentPosition(p => map.flyTo({ center: [p.coords.longitude, p.coords.latitude], zoom: 15 })); document.getElementById('slider-dot').style.transform = "translateX(16px)"; } else { document.getElementById('slider-dot').style.transform = "translateX(0)"; } }
    </script>
</body>
</html>
